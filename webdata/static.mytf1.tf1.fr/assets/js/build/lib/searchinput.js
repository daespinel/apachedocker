define(["lib/autocomplete"],function(e){function t(s){this.body=document.getElementsByTagName("body")[0],this.container=s,this.search_input_container=this.container.getElementsByClassName("search_input_container")[0],this.search_input=this.container.getElementsByClassName("search_input")[0],this.search_btn=this.container.getElementsByClassName("search_button")[0],this.quit_search_btn=this.container.getElementsByClassName("search_close")[0],this.suggest_box=this.container.getElementsByClassName("suggest_box")[0],this.resultList=this.container.getElementsByClassName("suggest_box_results")[0],this.suggest_box_timeout=350,this.autocomplete=new e("/_suggest",{elements:[this.search_input],resultList:this.resultList},function(e,s,i){if("undefined"!=typeof s.main&&s.main.length>0&&e.appendChild(t.prototype.printPerfectMatches(s,i)),"undefined"!=typeof s.alternative&&s.alternative.length>0){var n=document.createElement("p");n.innerHTML="Rechercher",e.appendChild(n),e.appendChild(t.prototype.printResults(s,i))}this.resultList.hasChildNodes()&&(this.resultList.style.display="block")}),this.addEvents();var i=class_userlib.getBrowser();return"Mobile Safari"==i.name&&i.major<=7&&this.addIosFixEvents(),this}return t.prototype.printPerfectMatches=function(e,t){var s=document.createElement("ul");return s.className="perfect_match",e.main.forEach(function(e){var i=document.createElement("li");i.innerHTML='<a href="'+e.url+'">'+utils.createPicture(e.image).outerHTML+"</a>",e.relatedContent.forEach(function(e){teaserTitle=e.text.replace(new RegExp(t,"gi"),'<span class="white">'+t+"</span>"),i.innerHTML+='<a href="'+e.url+'"><p class="title">'+teaserTitle+"</p></a>"}),s.appendChild(i)}),s},t.prototype.printResults=function(e,t){var s=document.createElement("ul");return s.className="results",e.alternative.forEach(function(e){var i=document.createElement("li");teaserTitle=e.text.replace(new RegExp(t,"gi"),'<span class="white">'+t+"</span>"),i.innerHTML='<a href="'+e.url+'"><p>'+teaserTitle+"</p></a>",s.appendChild(i)}),s},t.prototype.addEvents=function(){this.search_input_container.addEventListener("click",function(){this.search_input.focus()}.bind(this),!0),this.search_input.addEventListener("focus",this.expandSearchInput.bind(this),!0),this.search_input.addEventListener("keyup",this.activate_btn_or_send.bind(this),!0),this.search_input.addEventListener("focusout",this.onFocusOut.bind(this),!0),this.search_btn.addEventListener("click",this.redirect_search.bind(this),!0),this.quit_search_btn.addEventListener("click",this.normalSearchInput.bind(this),!0)},t.prototype.activate_btn_or_send=function(e){this.search_input.value.length>=3?(this.search_btn.disabled=!1,13==e.keyCode?this.redirect_search():!1):this.search_btn.disabled=!0},t.prototype.expandSearchInput=function(){utils.removeClass(this.body,"header-opened"),utils.addClass(this.container,"search_open"),utils.removeClass(this.search_btn,"hide"),utils.removeClass(this.quit_search_btn,"hide"),this.autocomplete.checkNeedSuggest(this.search_input),setTimeout(function(){this.suggest_box.style.width=(this.search_input.offsetWidth+this.search_btn.offsetWidth)/10+"em",this.suggest_box.style.maxHeight=.9*window.innerHeight/10+"em"}.bind(this),this.suggest_box_timeout)},t.prototype.normalSearchInput=function(e){utils.removeClass(this.container,"search_open"),utils.addClass(this.search_btn,"hide"),utils.addClass(this.quit_search_btn,"hide"),this.suggest_box.style.maxHeight="0"},t.prototype.redirect_search=function(e){window.location.href="/recherche?q="+encodeURIComponent(this.search_input.value)},t.prototype.onFocusOut=function(e){this.suggest_box.style.maxHeight="0",e.relatedTarget&&(e.relatedTarget.hasAttribute("href")?document.location=e.relatedTarget.getAttribute("href"):e.relatedTarget.parentNode&&e.relatedTarget.parentNode.hasAttribute("href")?document.location=e.relatedTarget.parentNode.getAttribute("href"):e.relatedTarget.parentNode.parentNode&&e.relatedTarget.parentNode.parentNode.hasAttribute("href")&&(document.location=e.relatedTarget.parentNode.parentNode.getAttribute("href")))},t.prototype.addIosFixEvents=function(){var e=function(e){e.preventDefault()},t=document.getElementById("TF1__header"),s=document.getElementById("TF1__menu");this.search_input.addEventListener("focus",function(){utils.addClass(document.body,"ios_focus"),setTimeout(function(){t.style.position=s.style.position="absolute",t.style.top=s.style.top=window.scrollY+"px"},0),window.addEventListener("touchmove",e)}.bind(this)),this.search_input.addEventListener("blur",function(){utils.removeClass(document.body,"ios_focus"),t.style.position=s.style.position="",t.style.top=s.style.top="",window.removeEventListener("touchmove",e)}.bind(this))},t});